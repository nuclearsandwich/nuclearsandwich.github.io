
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>A Look at Ruby Case Expressions - Mad Ramblings of a Lunatic Hacker</title>
  <meta name="author" content="Steven! Ragnarök">

  
  <meta name="description" content="Ruby, like many languages has a case-when construct for more refined conditional
execution than if-then-else can provide. Technically all case &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.nuclearsandwich.com/blog/2011/09/08/a-look-at-ruby-case-expressions/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Mad Ramblings of a Lunatic Hacker" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Mad Ramblings of a Lunatic Hacker</a></h1>
  
    <h2>An Exercise in Wit or Vanity</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://duckduckgo.com/" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.nuclearsandwich.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul role=main-navigation>
  <li><a href="http://nuclearsandwich.com">Home</a></li>
  <li><a href="http://nuclearsandwich.com/about">About</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/cage">Cage</a></li>
  <li><a href="/heyruby">Hey Ruby‽</a></li>
  <li><a href="/pheromone">Pheromone</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">A Look at Ruby Case Expressions</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-09-08T08:33:00-07:00" pubdate data-updated="true">Sep 8<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Ruby, like many languages has a case-when construct for more refined conditional
execution than if-then-else can provide. Technically all case constructs could
be written as if-then-else-if-then&#8230;else but you wouldn&#8217;t enjoy it.</p>

<h2>Ruby&#8217;s case-when is an expression</h2>

<p>However, there are a number of things that make Ruby&#8217;s case-when special. The
first comes from Ruby&#8217;s functional roots. It&#8217;s powerful but deceptively simple.
Ruby&#8217;s case-when construct is an <em>expression</em>. Which means, among other things,
it returns a value.</p>

<p>In a traditional imperative style a case statement might look like:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">conditional_variable</span> <span class="o">=</span> <span class="ss">:some_default_value</span>
</span><span class='line'><span class="k">case</span> <span class="n">our_condition</span>
</span><span class='line'><span class="k">when</span> <span class="ss">:first</span>
</span><span class='line'>  <span class="n">conditional_variable</span> <span class="o">=</span> <span class="ss">:one_thing</span>
</span><span class='line'><span class="k">when</span> <span class="ss">:then</span>
</span><span class='line'>  <span class="n">conditional_variable</span> <span class="o">=</span> <span class="ss">:another</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The that isn&#8217;t ideal for a number of reasons. <code>conditional_variable</code> is set
visibly three times which as any freshman can tell you is frowned upon.
Academics have stuffier reasons for it but the most important is that it
decreases readability because we aren&#8217;t sure what the value will be after
execution. Setting it so many times is also a code duplication, albeit a small
one. We can take advantage of Ruby&#8217;s case-when <em>expression</em> with this code:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">conditional_variable</span> <span class="o">=</span> <span class="k">case</span> <span class="n">our_condition</span>
</span><span class='line'>                       <span class="k">when</span> <span class="ss">:first</span>
</span><span class='line'>                         <span class="ss">:one_thing</span>
</span><span class='line'>                       <span class="k">when</span> <span class="ss">:then</span>
</span><span class='line'>                         <span class="ss">:another</span>
</span><span class='line'>                       <span class="k">else</span>
</span><span class='line'>                         <span class="ss">:some_default_value</span>
</span><span class='line'>                       <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doesn&#8217;t that look nicer? <code>conditional_variable</code> is only set once and the
intent is clear, we want the value to depend on <code>our_condition</code>.</p>

<h2>case-when uses triple equals for comparison</h2>

<p>This got me good this morning and spawned this article. If you&#8217;re not familiar
with <code>===</code> in Ruby then the best explanation comes from <em>_why&#8217;s Poignant Guide
to Ruby</em> which really is worth reading. I&#8217;ve referred back to it multiple times
to help myself and those around me fully understand basic Ruby concepts like
<code>nil</code>, truthiness and falsiness, and, <strong>fanfare please</strong>, double equals versus
triple equals.</p>

<blockquote><p>The double equals gives the appearance of a short link of ropes, right
along the sides of a red carpet where only <code>true</code> can be admitted.</p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="n">approaching_guy</span> <span class="o">==</span> <span class="kp">true</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;That necklace is classic&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>&#8230;
[This case-when statement]</p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">case</span> <span class="n">year</span>
</span><span class='line'><span class="k">when</span> <span class="mi">1894</span>
</span><span class='line'>  <span class="s2">&quot;Born.&quot;</span>
</span><span class='line'><span class="k">when</span> <span class="p">(</span><span class="mi">1895</span><span class="o">.</span><span class="n">.</span><span class="mi">1913</span><span class="p">)</span>
</span><span class='line'>  <span class="s2">&quot;Childhood in Lousville, Winston Co., Mississippi.&quot;</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="s2">&quot;No information about this year.&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>is identical to</p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="mi">1894</span> <span class="o">===</span> <span class="n">year</span>
</span><span class='line'>  <span class="s2">&quot;Born.&quot;</span>
</span><span class='line'><span class="k">elsif</span> <span class="p">(</span><span class="mi">1895</span><span class="o">.</span><span class="n">.</span><span class="mi">1913</span><span class="p">)</span> <span class="o">===</span> <span class="n">year</span>
</span><span class='line'>  <span class="s2">&quot;Childhood in Lousville, Winston Co., Mississippi.&quot;</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="s2">&quot;No information about this year.&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>The <strong>triple equals</strong> is a length of velvet rope, checking values much like
the <strong>double equals</strong>. It&#8217;s just: the triple equals is a longer rope and it
sags a bit in the middle. It&#8217;s not as strict, it&#8217;s a bit more flexible.
Take the Ranges above. <code>(1895..1913)</code> isn&#8217;t at all equal to <code>1905</code>.</p>

<p>No, the Range <code>(1895..1913)</code> is only truly equal to any other Range
<code>(1895..1913)</code>. In the case of a Range, the triple equals cuts you a break
and lets the Integer <code>1905</code> in, because even though it&#8217;s not equal to the
Range, it&#8217;s included in the set of Integers represented by the Range. Which
is good enough in some cases, such as the timeline I put together earlier.</p></blockquote>

<h2>My Mistake</h2>

<p>This is what I did which caused me to write this as penance.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">local_tweet_object</span> <span class="n">input</span>
</span><span class='line'>  <span class="n">tweet_hash</span> <span class="o">=</span> <span class="k">case</span> <span class="n">input</span><span class="o">.</span><span class="n">class</span> <span class="c1"># the screw-up</span>
</span><span class='line'>  <span class="k">when</span> <span class="nb">String</span>
</span><span class='line'>    <span class="no">MultiJson</span><span class="o">.</span><span class="n">decode</span> <span class="n">input</span>
</span><span class='line'>  <span class="k">when</span> <span class="no">Hash</span>
</span><span class='line'>    <span class="n">input</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="nb">fail</span> <span class="no">ArgumentError</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
</span><span class='line'>      <span class="s2">&quot;Cannot process </span><span class="si">#{</span><span class="n">input</span><span class="o">.</span><span class="n">class</span><span class="si">}</span><span class="s2"> only String or Hash&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="no">LocalTweet</span><span class="o">.</span><span class="n">new</span> <span class="n">tweet_hash</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code was raising the following error.</p>

<p><code>ArgumentError: I don't want Hash give me only String or Hash</code>
&#8230; <em>huh?</em></p>

<p>At first glance it looked fine, but then we remember that case-when uses <code>===</code>.
Again, we think &#8220;this shouldn&#8217;t be an issue, if it&#8217;s good enough for <code>==</code> it
should be fine for <code>===</code>.&#8221; But <code>===</code> behaves specially for certain types in Ruby
such as Classes, Arrays, and as we saw before, Ranges.</p>

<p>For simple scalar values <code>===</code> acts like you expect.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>12 === 12 #=> true
</span><span class='line'>12 === 13 #=> false
</span><span class='line'>:rats === :rats #=> true
</span><span class='line'>"pens" === "pens" #=> true
</span><span class='line'>"space" === "fact" #=> false</span></code></pre></td></tr></table></div></figure>


<p>And we know how <code>===</code> treats ranges</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(8..64) === 32 #=> true</span></code></pre></td></tr></table></div></figure>


<p>But note that</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(8..64) === (8..64) #=> false</span></code></pre></td></tr></table></div></figure>


<p>Suddenly!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Integer === 12 #=> true!</span></code></pre></td></tr></table></div></figure>


<p>waitaminute.. what?</p>

<p>So Ruby can tell that <code>12</code> is a type of Integer and thus <code>===</code> can be described
partially as an includes and typeof operator. But there are some further
gotchas.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[ 1, 2, 3 ] === 1#=> true
</span><span class='line'>[ 1, 2, 3 ] === [ 1, 2, 3 ]                         #=> true
</span><span class='line'>[ 1, 2, 3 ] === [ 1, 2 ]                            #=> false
</span><span class='line'>{ :foo => :bar } === { :foo => :bar }               #=> true
</span><span class='line'>{ :foo => :bar } === :foo                           #=> false
</span><span class='line'>{ :foo => :bar, :baz => :qux } === { :foo => :bar } #=> false</span></code></pre></td></tr></table></div></figure>


<p><code>===</code>&#8217;s behavior isn&#8217;t completely intuitive even within Ruby&#8217;s standard Classes.
Which brings us (finally) back around to my original error.
<code>Hash === Hash #=&gt; false</code></p>

<p>The fix is simple, just change</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>case input.class</span></code></pre></td></tr></table></div></figure>


<p>to</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>case input</span></code></pre></td></tr></table></div></figure>


<p>I posted on identi.ca a friendly notice about this easy mistake and was asked to
provide clarification. So here, just over 24 hours late, it is. The full source
code is provided <a href="https://gist.github.com/1112335">here</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Steven! Ragnarök</span></span>

      








  


<time datetime="2011-09-08T08:33:00-07:00" pubdate data-updated="true">Sep 8<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/programming/'>Programming</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.nuclearsandwich.com/blog/2011/09/08/a-look-at-ruby-case-expressions/" data-via="nuclearsandwich" data-counturl="http://blog.nuclearsandwich.com/blog/2011/09/08/a-look-at-ruby-case-expressions/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/09/03/switching-to-octopress/" title="Previous Post: Switching to Octopress">&laquo; Switching to Octopress</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/10/28/there-are-10-types-of-tests-you-need-both-of-them/" title="Next Post: There Are 10 Types of Tests. You Need Both of Them">There Are 10 Types of Tests. You Need Both of Them &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/31/gogaruco-2012-teaching-language-semantics/">GoGaRuCo 2012: Teaching Language Semantics</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/16/how-i-used-a-debugging-feature-of-pry-to-build-cage/">How I Used a "Debugging Feature" of Pry to Build Cage</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/15/jeff-atwood-misses-the-point/">Jeff Atwood Misses the Point</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/09/stop-counting-your-points/">Stop Counting Your Points</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/10/two-reviews-the-developers-code-and-code-simplicity/">Two Reviews: The Developer's Code and Code Simplicity</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/04/bound-by-our-past/">Bound by our Past</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/02/on-learning-making-and-checking-assumptions/">On Learning: Making and Checking Assumptions</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/nuclearsandwich">@nuclearsandwich</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'nuclearsandwich',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("nuclearsandwich", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/nuclearsandwich" class="twitter-follow-button" data-show-count="false">Follow @nuclearsandwich</a>
  
</section>


<section>
  <h1>My Pinboard</h1>
  <ul id="pinboard_linkroll">Fetching linkroll...</ul>
  <p><a href="http://pinboard.in/u:nuclearsandwich">My Pinboard Bookmarks &raquo;</a></p>
</section>
<script type="text/javascript">
  var linkroll = 'pinboard_linkroll'; //id target for pinboard list
  var pinboard_user = "nuclearsandwich"; //id target for pinboard list
  var pinboard_count = 5; //id target for pinboard list
  (function(){
    var pinboardInit = document.createElement('script');
    pinboardInit.type = 'text/javascript';
    pinboardInit.async = true;
    pinboardInit.src = '/javascripts/pinboard.js';
    document.getElementsByTagName('head')[0].appendChild(pinboardInit);
  })();
</script>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Steven! Ragnarök -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4f7a8451f5a1f5418400002a');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>


</body>
</html>
